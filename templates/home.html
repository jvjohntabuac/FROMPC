                                                                                                                                                                                                                                                                                                                <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>
    <!-- Navbar Toggle Button -->
    <button onclick="toggleNavbar()" id="nav-toggle" class="nav-toggle">☰</button>

    <!-- Sidebar Navbar -->
    <div id="navbar" class="navbar">
        <button onclick="closeNavbar()" class="nav-close">×</button>
        <ul>
            <li><a href="/create_post" class="block py-2 px-4 hover:bg-gray-600">Create a New Post</a></li>
            <li><a href="/DLC" class="block py-2 px-4 hover:bg-gray-600">DLC</a></li>
            <li><a href="/profile" class="block py-2 px-4 hover:bg-gray-600">Profile</a></li>
        </ul>
        <a href="/logout" class="logout-button block py-2 px-4 mt-4 bg-red-600 hover:bg-red-800 text-center">Logout</a>
    </div>

    <!-- Chibi Container -->
<div class="chibi-container">
   <!-- Chibi Container -->
<div class="chibi-container">
    <img src="{{ url_for('static', filename='uploads/chibi.png') }}" alt="Chibi Character" class="chibi-img" onclick="handleChibiClick()">
    <div id="comic-popup" class="comic-popup">
        <div class="comic-arrow"></div>
       HALLOOOO!
    </div>
</div>
<!-- Sprite Image -->
<img src="{{ url_for('static', filename='uploads/sprite.png') }}" alt="Sprite" id="sprite-img" class="sprite-img">

<!-- Second Sprite Image -->
<img src="{{ url_for('static', filename='uploads/sprite2.png') }}" alt="Sprite2" id="sprite2-img" class="sprite-img">






</div>
<!-- Text Box -->
<div id="text-box" class="text-box">
</div>



    <!-- Main Content Area -->
    <div class="main-content">
        <h1>Welcome, {{ username }}</h1>
        <h2>Recent Posts</h2>
        <div class="posts-container mt-4">
            {% for post in posts %}
            <div class="post mb-4 p-4 border border-gray-300 rounded-lg">
                <div class="flex items-center mb-2">
                    <div class="mr-4">
                        <button id="like-button-{{ post.id }}" 
                                data-post-id="{{ post.id }}" 
                                class="like-button {{ 'liked' if post.is_liked_by_current_user else '' }}" 
                                onclick="debouncedToggleLike(event, '{{ post.id }}')">
                            <span id="like-count-{{ post.id }}" class="like-count">{{ post.like_count }}</span> Like
                        </button>
                    </div>
                    <p><strong>{{ post.username }}</strong>: {{ post.content }}</p>
                </div>
                {% if post.image_url %}
                <img src="{{ post.image_url }}" alt="{{ post.content | truncate(80, true, '...') }}" style="max-width: 100%; height: auto;">
                {% endif %}
                <p class="text-gray-500 text-sm">Posted on {{ post.created_at }}</p>
            </div>
            {% else %}
            <p>No posts to show.</p>
            {% endfor %}
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        function togglePopup() {
            var popup = document.getElementById("comic-popup");
            popup.style.display = (popup.style.display === "none" || popup.style.display === "") ? "block" : "none";
        }
        
        function toggleSprite() {
            var popup = document.getElementById("comic-popup");
            var sprite = document.getElementById("sprite-img"); // Ensure the ID matches
        
            if (popup.style.display === "none" || popup.style.display === "") {
                popup.style.display = "block";
            } else if (sprite.style.display === "none" || sprite.style.display === "") {
                sprite.style.display = "block";
                setTimeout(function() {
                    sprite.classList.add("show");
                }, 10); // Add a slight delay for the transition effect
            }
        }
        
        window.onload = function() {
            makeDraggable(document.getElementById("comic-popup"));
        }
        
        let debounceTimeout;
        let typingInterval;
        
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        let clickCount = 0;
        let spriteClickCount = 0; // Counter for sprite clicks
        const messages = [
            "Welcome to our website! We're excited to have you join our community. Explore our content, discover new features, and feel free to reach out if you need any assistance. Enjoy your visit!",
            "dafyavfadfvday",
            "dafyavfadfvday",
            "dafyavfadfvday",
        ];
        
        function typeText(element, text, callback) {
            clearInterval(typingInterval); // Clear any previous typing intervals
            element.textContent = ""; // Ensure the text box is cleared before typing
            let index = 0;
            typingInterval = setInterval(() => {
                element.textContent += text[index];
                index++;
                if (index === text.length) {
                    clearInterval(typingInterval);
                    if (callback) callback();
                }
            }, 50); // Typing speed (lower value = faster typing)
        }
        
        function handleChibiClick() {
            clickCount++;
            const popup = document.getElementById("comic-popup");
            const sprite = document.getElementById("sprite-img");
            const chibi = document.querySelector(".chibi-img");
            const textBox = document.getElementById("text-box");
        
            if (clickCount === 1) {
                popup.style.display = "block";
            } else if (clickCount === 2) {
                popup.style.display = "none";
                sprite.style.display = "block";
                sprite.src = "{{ url_for('static', filename='uploads/sprite.png') }}"; // Load initial sprite
                chibi.style.display = "none"; // Hide chibi image
                textBox.style.display = "block"; // Show text box
                typeText(textBox, messages[0]); // Start typing the first message
                spriteClickCount = 0; // Reset sprite click count
            }
        }
        
        function handleSpriteClick() {
            spriteClickCount++;
            const sprite = document.getElementById("sprite-img");
            const textBox = document.getElementById("text-box");
        
            if (spriteClickCount === 1) {
                sprite.src = "{{ url_for('static', filename='uploads/sprite2.png') }}"; // Change sprite image
                sprite.style.right = "0"; // Move sprite to the right side
                sprite.style.width = "50%"; // Adjust size
                textBox.classList.add("hidden"); // Hide text box
                document.removeEventListener('click', handleDocumentClick); // Remove click event listener
            } else {
                const currentMessage = messages[spriteClickCount];
                if (currentMessage) {
                    textBox.textContent = ""; // Clear text box before typing the next message
                    typeText(textBox, currentMessage); // Start typing the next message
                }
            }
        }
        
        function handleDocumentClick() {
            const textBox = document.getElementById("text-box");
            
            if (textBox.style.display === "block") {
                const currentMessage = textBox.textContent.trim(); // Trim spaces and newlines
                const nextMessageIndex = messages.indexOf(currentMessage) + 1;
                
                if (nextMessageIndex < messages.length) {
                    textBox.textContent = ""; // Clear text box before typing the next message
                    typeText(textBox, messages[nextMessageIndex]); // Start typing the next message
                } else {
                    textBox.textContent += " [End of messages]"; // Indicate end of messages if desired
                }
            }
        }
        
        // Attach the click event to the chibi image
        document.querySelector(".chibi-img").addEventListener("click", handleChibiClick);
        
        // Attach the click event to the sprite image
        document.getElementById("sprite-img").addEventListener("click", handleSpriteClick);

        
        
        // Attach the click event to the document
        document.addEventListener('click', handleDocumentClick);
        

//NAVBAR
        function toggleNavbar() {
            const navbar = document.getElementById("navbar");
            const navToggle = document.getElementById("nav-toggle");
            navbar.classList.toggle("active");
            navToggle.classList.toggle("hidden");

            
        }

        function closeNavbar() {
            const navbar = document.getElementById("navbar");
            const navToggle = document.getElementById("nav-toggle");
            navbar.classList.remove("active");
            navToggle.classList.remove("hidden");

            localStorage.setItem("navbar_active", 'false');
            localStorage.setItem("nav_toggle_hidden", 'false');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const navbar = document.getElementById("navbar");
            const navToggle = document.getElementById("nav-toggle");

            const isNavbarActive = localStorage.getItem("navbar_active") === 'true';
            const isNavToggleHidden = localStorage.getItem("nav_toggle_hidden") === 'true';

            if (isNavbarActive) {
                navbar.classList.add("active");
                navToggle.classList.add("hidden");
            } else {
                navbar.classList.remove("active");
                navToggle.classList.remove("hidden");
            }

            const likeButtons = document.querySelectorAll('.like-button');
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            likeButtons.forEach(button => {
                const postId = button.getAttribute('data-post-id');
                const likeCountElement = document.getElementById(`like-count-${postId}`);

                fetch(`/get_like_count?post_id=${postId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error fetching like count:', data.error);
                            return;
                        }
                        likeCountElement.textContent = data.like_count;
                    })
                    .catch(error => console.error('Error fetching like count:', error));

                button.addEventListener('click', (event) => {
                    debouncedToggleLike(event, postId);
                });
            });
        });

        function toggleLike(event, postId) {
            event.preventDefault();
            const likeButton = document.getElementById(`like-button-${postId}`);
            const likeCountElement = document.getElementById(`like-count-${postId}`);
            let currentLikeCount = parseInt(likeCountElement.textContent, 10);
            const isLiked = likeButton.classList.contains('liked');
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            likeButton.disabled = true;

            if (isLiked) {
                currentLikeCount -= 1;
                likeButton.classList.remove('liked');
            } else {
                currentLikeCount += 1;
                likeButton.classList.add('liked');
            }

            likeCountElement.textContent = currentLikeCount;

            fetch('/like_post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({ post_id: postId }).toString(),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error updating like state on server:', data.error);
                    if (isLiked) {
                        currentLikeCount += 1;
                        likeButton.classList.add('liked');
                    } else {
                        currentLikeCount -= 1;
                        likeButton.classList.remove('liked');
                    }
                    likeCountElement.textContent = currentLikeCount;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                likeButton.disabled = false;
            });
        }

        const debouncedToggleLike = debounce(toggleLike, 300);
    </script>
</body>
</html>
